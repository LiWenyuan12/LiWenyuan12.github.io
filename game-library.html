<script src="common.js"></script>
<script>
  initCommon();

  // 存放从 JSON 加载的数据
  let gameData = [];

  // 获取 DOM
  const libSearch = document.getElementById("libSearch");
  const libType = document.getElementById("libType");
  const libPrice = document.getElementById("libPrice");
  const libPlatforms = document.getElementById("libPlatforms");
  const libList = document.getElementById("libList");
  const libResultCount = document.getElementById("libResultCount");

  // 平台多选
  function getSelectedPlatforms() {
    return Array.from(
      libPlatforms.querySelectorAll("input[type=checkbox]:checked")
    ).map((el) => el.value);
  }

  // 筛选逻辑
  function matchesFilters(game, keyword, type, price, platforms) {
    const kw = keyword.trim().toLowerCase();
    if (kw) {
      const text = (game.name + " " + game.tags.join(" ")).toLowerCase();
      if (!text.includes(kw)) return false;
    }

    if (type !== "all" && game.type !== type) return false;

    if (platforms.length) {
      const hit = game.platforms.some((p) => platforms.includes(p));
      if (!hit) return false;
    }

    if (price === "free" && game.price !== 0) return false;
    if (price === "low" && !(game.price > 0 && game.price <= 100)) return false;
    if (price === "high" && !(game.price > 100)) return false;

    return true;
  }

  // 渲染列表
  function renderList() {
    const keyword = libSearch.value;
    const type = libType.value;
    const price = libPrice.value;
    const platforms = getSelectedPlatforms();

    const filtered = gameData.filter((g) =>
      matchesFilters(g, keyword, type, price, platforms)
    );

    libList.innerHTML = "";
    libResultCount.textContent = `共 ${filtered.length} 款`;

    if (!filtered.length) {
      libList.innerHTML =
        '<div style="font-size:12px;color:var(--text-muted);">没有找到符合条件的游戏，可以尝试放宽筛选条件。</div>';
      return;
    }

    filtered.forEach((g) => {
      const div = document.createElement("div");
      div.className = "game-card";

      // 封面路径自动生成
      const coverPath = `../images/covers/${g.id}.jpg`;

      div.innerHTML = `
        <div class="game-cover" style="background-image: url('${coverPath}')"></div>
        <div class="game-info">
          <div class="game-name">${g.name}</div>
          <div class="game-meta">
            类型：${g.type.toUpperCase()} · 平台：${g.platforms.join("/")} · 评分：${g.rating.toFixed(1)}
          </div>
          <div class="game-footer">
            ${
              g.price === 0
                ? '<span class="tag tag--accent">免费</span>'
                : `<span class="tag">价格：¥${g.price}</span>`
            }
            ${g.tags.map((t) => `<span class="tag">${t}</span>`).join("")}
          </div>
        </div>
      `;

      // 示例跳转
      div.addEventListener("click", () => {
        if (g.id === "elden-ring") {
          window.location.href = "game-detail.html";
        }
      });

      libList.appendChild(div);
    });
  }

  // 监听筛选事件
  libSearch.addEventListener("input", renderList);
  libType.addEventListener("change", renderList);
  libPrice.addEventListener("change", renderList);
  libPlatforms.addEventListener("change", renderList);

  // 读取 JSON 文件
  fetch("games-library.json")
    .then((res) => res.json())
    .then((data) => {
      gameData = data;

      // 如果首页传了 cat 参数（分类）
      const params = new URLSearchParams(window.location.search);
      const cat = params.get("cat");

      if (cat) {
        if (
          ["action", "rpg", "strategy", "indie", "multiplayer", "casual"].includes(cat)
        ) {
          libType.value = cat;
        } else if (cat === "free") {
          libPrice.value = "free";
        }
      }

      renderList(); // 数据加载后开始渲染
    })
    .catch((err) => {
      console.error("加载 games-library.json 出错：", err);
    });
</script>

