<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>GameBox æ¸¸ç›’ - æ¸¸æˆåº“</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="index.css" />
</head>
<body data-current-page="library">
<div class="page">
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo">
        <div class="logo-mark">G</div>
        <div>
          <div>GameBox æ¸¸ç›’</div>
          <div class="logo-sub">LIGHTWEIGHT GAME HUB</div>
        </div>
      </a>

      <nav class="nav-main">
        <a href="index.html" data-page="home" class="nav-link">é¦–é¡µ</a>
        <a href="news-list.html" data-page="news" class="nav-link">èµ„è®¯</a>
        <a href="game-library.html" data-page="library" class="nav-link">æ¸¸æˆåº“</a>
        <a href="ranking.html" data-page="ranking" class="nav-link">
          æ’è¡Œæ¦œ <span class="badge">HOT</span>
        </a>
        <a href="discount.html" data-page="discount" class="nav-link">æŠ˜æ‰£ / å²ä½</a>
        <a href="community.html" data-page="community" class="nav-link">ç¤¾åŒº</a>
        <a href="my-library.html" data-page="my" class="nav-link">æˆ‘çš„æ¸¸æˆ</a>
        <a href="tools.html" data-page="tools" class="nav-link">å·¥å…·ä¸­å¿ƒ</a>
        <a href="profile.html" data-page="profile" class="nav-link">ç”¨æˆ·ä¸­å¿ƒ</a>
      </nav>

      <div class="header-right">
        <div class="header-search">
          <input type="text" placeholder="æœç´¢æ¸¸æˆ / èµ„è®¯ / å¸–å­" />
          <span class="header-search-icon">Search</span>
        </div>
        <button class="header-user">æœªç™»å½• Â· æ¸¸å®¢</button>
      </div>
    </div>
  </header>

  <main class="main">
    <section>
      <div class="card">
        <div class="page-title">æ¸¸æˆåº“</div>
        <div class="page-intro">
          é€šè¿‡åç§°ã€ç±»å‹ã€å¹³å°å’Œä»·æ ¼åŒºé—´æ¥ç­›é€‰ä½ æ„Ÿå…´è¶£çš„æ¸¸æˆï¼ˆç¤ºä¾‹æ•°æ®ï¼‰ã€‚
        </div>
      </div>

      <div class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span>
            <span>ç­›é€‰æ¡ä»¶</span>
          </div>
        </header>

        <div class="form">
          <div class="form-row">
            <label for="libSearch">æŒ‰åç§°æœç´¢</label>
            <input type="text" id="libSearch" placeholder="è¾“å…¥æ¸¸æˆåï¼Œå¦‚ï¼šè‰¾å°”ç™»æ³•ç¯" />
          </div>

          <div class="form-row">
            <label for="libType">ç±»å‹</label>
            <select id="libType">
              <option value="all">å…¨éƒ¨ç±»å‹</option>
              <option value="å¼€æ”¾ä¸–ç•Œ">å¼€æ”¾ä¸–ç•Œ</option>
              <option value="åŠ¨ä½œ">åŠ¨ä½œ</option>
              <option value="é­‚ç±»">é­‚ç±»</option>
              <option value="å›åˆåˆ¶RPG">å›åˆåˆ¶RPG</option>
              <option value="æ¨¡æ‹Ÿç»è¥">æ¨¡æ‹Ÿç»è¥</option>
              <option value="æ²™ç›’">æ²™ç›’</option>
              <option value="Roguelike">Roguelike</option>
              <option value="å¡ç‰ŒRoguelike">å¡ç‰ŒRoguelike</option>
              <option value="ç”Ÿå­˜">ç”Ÿå­˜</option>
              <option value="ç­–ç•¥">ç­–ç•¥</option>
            </select>
          </div>

          <div class="form-row">
            <label for="libPrice">ä»·æ ¼åŒºé—´</label>
            <select id="libPrice">
              <option value="all">å…¨éƒ¨</option>
              <option value="free">å…è´¹ / F2P</option>
              <option value="low">100 å…ƒä»¥ä¸‹</option>
              <option value="high">100 å…ƒä»¥ä¸Š</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span>
            <span>ç­›é€‰ç»“æœ</span>
          </div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <div class="chip" id="libResultCount">å…± 0 æ¬¾</div>
            <div class="chip" id="liveIndicator" style="background: #10b981; color: white; animation: pulse 2s infinite;">
              â— å®æ—¶æ•°æ®
            </div>
          </div>
        </header>
        <div id="libList" class="game-list"></div>
      </div>
    </section>

    <aside>
      <div class="sidebar-card">
        <div class="sidebar-title">å®æ—¶æ•°æ®</div>
        <div class="sidebar-item">
          <span class="label">åœ¨çº¿ç©å®¶æ€»æ•°</span>
          <span class="value" id="totalOnline">åŠ è½½ä¸­...</span>
        </div>
        <div class="sidebar-item">
          <span class="label">æŠ˜æ‰£æ¸¸æˆ</span>
          <span class="value" id="discountCount">0 æ¬¾</span>
        </div>
        <div class="sidebar-item">
          <span class="label">æ›´æ–°é¢‘ç‡</span>
          <span class="value">æ¯ 30 ç§’</span>
        </div>
        <div class="sidebar-item">
          <span class="label">æ•°æ®æ¥æº</span>
          <span class="value">æ¨¡æ‹Ÿå®æ—¶æ•°æ®</span>
        </div>
      </div>
    </aside>
  </main>
</div>

<style>
  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.7;
    }
  }
  
  .game-card {
    transition: transform 0.2s, box-shadow 0.2s;
  }
  
  .game-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
</style>

<script src="common.js"></script>
<script>
  initCommon();

  let gameData = [];
  let updateInterval = null;

  const libSearch = document.getElementById("libSearch");
  const libType   = document.getElementById("libType");
  const libPrice  = document.getElementById("libPrice");
  const libList   = document.getElementById("libList");
  const libResultCount = document.getElementById("libResultCount");
  const totalOnline = document.getElementById("totalOnline");
  const discountCount = document.getElementById("discountCount");

  // æ ¼å¼åŒ–åœ¨çº¿ç©å®¶æ•°
  function formatPlayers(num) {
    if (!num) return '0';
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
    return num.toString();
  }

  // è·å–è¶‹åŠ¿å›¾æ ‡
  function getTrendingIcon(trending) {
    if (trending === 'hot') return 'ğŸ”¥';
    if (trending === 'up') return 'ğŸ“ˆ';
    if (trending === 'down') return 'ğŸ“‰';
    return 'â–';
  }

  // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
  function updateStats() {
    const total = gameData.reduce((sum, g) => sum + (g.onlinePlayers || 0), 0);
    const discounts = gameData.filter(g => g.discount && g.discount > 0).length;
    
    if (totalOnline) {
      totalOnline.textContent = formatPlayers(total);
    }
    if (discountCount) {
      discountCount.textContent = `${discounts} æ¬¾`;
    }
  }

  function renderList() {
    let filtered = gameData;

    // å…³é”®è¯æœç´¢
    const kw = libSearch.value.trim();
    if (kw) {
      filtered = filtered.filter(g =>
        g.name.includes(kw) || g.description.includes(kw)
      );
    }

    // ç±»å‹ç­›é€‰
    if (libType.value !== "all") {
      filtered = filtered.filter(g => g.type === libType.value);
    }

    // ä»·æ ¼ç­›é€‰
    if (libPrice.value === "free") {
      filtered = filtered.filter(g => g.price.includes("å…è´¹"));
    } else if (libPrice.value === "low") {
      filtered = filtered.filter(g => {
        const match = g.price.match(/Â¥(\d+)/);
        return match && parseInt(match[1]) <= 100;
      });
    } else if (libPrice.value === "high") {
      filtered = filtered.filter(g => {
        const match = g.price.match(/Â¥(\d+)/);
        return match && parseInt(match[1]) > 100;
      });
    }

    libResultCount.textContent = `å…± ${filtered.length} æ¬¾`;
    libList.innerHTML = "";

    if (filtered.length === 0) {
      libList.innerHTML = '<div style="text-align:center;padding:60px;color:#888;">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ¸¸æˆ</div>';
      return;
    }

    filtered.forEach(game => {
      const div = document.createElement("div");
      div.className = "game-card";

      // æ„å»ºå®æ—¶æ•°æ®æ˜¾ç¤º
      let liveDataHTML = '';
      if (game.onlinePlayers !== undefined) {
        liveDataHTML = `
          <div style="margin-top: 8px; display: flex; gap: 12px; flex-wrap: wrap; font-size: 0.9em;">
            <span style="color: #10b981; font-weight: 500;">
              ğŸ‘¥ ${formatPlayers(game.onlinePlayers)} åœ¨çº¿
            </span>
        `;

        // æ˜¾ç¤ºä»·æ ¼å’ŒæŠ˜æ‰£
        if (game.discount && game.discount > 0) {
          liveDataHTML += `
            <span style="color: #ef4444; font-weight: 500;">
              ğŸ’° -${game.discount}% æŠ˜æ‰£
            </span>
            <span style="text-decoration: line-through; color: #999;">
              Â¥${game.priceOriginal}
            </span>
            <span style="color: #10b981; font-weight: bold;">
              Â¥${game.priceNow}
            </span>
          `;
        } else if (game.priceNow > 0) {
          liveDataHTML += `
            <span style="color: #666;">
              ğŸ’° Â¥${game.priceNow}
            </span>
          `;
        }

        // æ˜¾ç¤ºè¶‹åŠ¿
        if (game.trending) {
          liveDataHTML += `
            <span style="font-size: 1.2em;" title="${game.trending}">
              ${getTrendingIcon(game.trending)}
            </span>
          `;
        }

        liveDataHTML += '</div>';
      }

      div.innerHTML = `
        <div class="game-cover" style="background-image:url('${game.cover}')"></div>
        <div class="game-info">
          <div class="game-name">${game.name}</div>
          <div class="game-meta">
            ${game.type} â€¢ è¯„åˆ† ${game.rating} â€¢ ${game.price}
          </div>
          <div class="game-desc">${game.description}</div>
          ${liveDataHTML}
        </div>
      `;

      libList.appendChild(div);
    });
  }

  // æ¨¡æ‹Ÿå®æ—¶æ•°æ®æ›´æ–°
  function simulateLiveUpdate() {
    gameData.forEach(game => {
      if (game.onlinePlayers !== undefined) {
        // åœ¨çº¿ç©å®¶æ•°éšæœºæ³¢åŠ¨ Â±5%
        const change = game.onlinePlayers * 0.05 * (Math.random() - 0.5);
        game.onlinePlayers = Math.max(0, Math.round(game.onlinePlayers + change));
        
        // éšæœºæ›´æ–°è¶‹åŠ¿
        const rand = Math.random();
        if (rand > 0.95) {
          game.trending = 'hot';
        } else if (rand > 0.7) {
          game.trending = 'up';
        } else if (rand > 0.5) {
          game.trending = 'down';
        } else {
          game.trending = 'stable';
        }
      }
    });
    
    renderList();
    updateStats();
  }

  // åŠ è½½æ¸¸æˆæ•°æ®
  fetch("games-library.json")
    .then(res => res.json())
    .then(data => {
      gameData = data;
      
      // ä¸ºæ²¡æœ‰å®æ—¶æ•°æ®çš„æ¸¸æˆæ·»åŠ é»˜è®¤å€¼
      gameData.forEach(game => {
        if (game.onlinePlayers === undefined) {
          game.onlinePlayers = Math.floor(Math.random() * 500000);
          
          // è§£æä»·æ ¼
          const priceMatch = game.price.match(/Â¥(\d+)/);
          if (priceMatch) {
            game.priceOriginal = parseInt(priceMatch[1]);
            game.priceNow = game.priceOriginal;
            game.discount = 0;
          } else {
            game.priceOriginal = 0;
            game.priceNow = 0;
            game.discount = 0;
          }
          
          // éšæœºè¶‹åŠ¿
          const trends = ['up', 'down', 'stable', 'hot'];
          game.trending = trends[Math.floor(Math.random() * trends.length)];
        }
      });
      
      renderList();
      updateStats();
      
      // å¯åŠ¨å®šæ—¶æ›´æ–°ï¼ˆ30ç§’ï¼‰
      if (updateInterval) clearInterval(updateInterval);
      updateInterval = setInterval(simulateLiveUpdate, 30000);
    })
    .catch(err => {
      console.error(err);
      libList.innerHTML = "<div style='color:red;padding:20px;'>åŠ è½½å¤±è´¥ï¼šæ‰¾ä¸åˆ° games-library.json</div>";
    });

  // ç­›é€‰äº‹ä»¶
  libSearch.addEventListener("input", renderList);
  libType.addEventListener("change", renderList);
  libPrice.addEventListener("change", renderList);

  // æ¸…ç†å®šæ—¶å™¨
  window.addEventListener('beforeunload', () => {
    if (updateInterval) clearInterval(updateInterval);
  });
</script>
</body>
</html>
